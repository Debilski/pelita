<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><title>Pelita</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="processing-1.3.6.min.js"></script> 

    
    <!-- Le styles -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding: 2em 3em;
      }

      img.tally-1 {
        height: 28px;
        width: 16px;
        background:url(tally_marks.png) 0 0;
      }
      img.tally-2 {
        height: 28px;
        width: 23px;
        background:url(tally_marks.png) -16px 0;
      }
      img.tally-3 {
        height: 28px;
        width: 26px;
        background:url(tally_marks.png) -44px 0;
      }
      img.tally-4 {
        height: 28px;
        width: 34px;
        background:url(tally_marks.png) -71px 0;
      }
      img.tally-5 {
        height: 28px;
        width: 36px;
        background:url(tally_marks.png) -103px 0;
      }
    </style>
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
  </head>
  <body>
    <div id="main">

      <script type="text/javascript">
        var agents = Array();
      </script>


      <h1><span class="team_0"><span class="name">Team a</span> <span class="score"></span></span> :
        <span class="team_1"><span class="score"></span> <span class="name">Team b</span></span></h1>

      <p><span id="ws_status" class="label"></span></p>

      <p><i class="icon-info-sign"></i>Round: <span id="round_index"></span>; Last bot: <span id="bot_id"></span></p>

      <h2>Killed</h2>
      <p class="team_0"><b class="name">Team</b>: <span class="kill_tally"></span></p>
      <p class="team_1"><b class="name">Team</b>: <span class="kill_tally"></span></p>

      <canvas id="canvas1" data-processing-sources="pelita.pde"></canvas>


      <script type="text/javascript">
        function getParameterByName(name) {
          // http://stackoverflow.com/questions/901115
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.location.search);
            if(results == null)
              return "";
            else
              return decodeURIComponent(results[1].replace(/\+/g, " "));
          }

          var ws_host = getParameterByName("host");
          var ws_uri = "ws://" + (ws_host || "localhost") + ":51011/";

          var ws = new WebSocket(ws_uri);
          ws.onmessage = function(event) { 
            data = JSON.parse(event.data);
            wall = data.walls;
            food = data.food;
            state = data.state;
            teams = data.teams;

            init_game();


            $(".team_0").each(function(idx) {
              $(this).find(".name").text(teams[0].name);
              $(this).find(".score").text(teams[0].score);

              var the_tally = "";
              for (var idx = 1; idx < (state.times_killed[0] + 1) / 5; idx++) the_tally += "<img class='tally-5'></img>";
              the_tally += "<img class='tally-" + (state.times_killed[0] % 5) + "'></img>";
              $(this).find(".kill_tally").html(the_tally);
            });
            $(".team_1").each(function(idx) {
              $(this).find(".name").text(teams[1].name);
              $(this).find(".score").text(teams[1].score);

              var the_tally = "";
              for (var idx = 1; idx < (state.times_killed[1] + 1) / 5; idx++) the_tally += "<img class='tally-5'></img>";
              the_tally += "<img class='tally-" + (state.times_killed[1] % 5) + "'></img>";
              $(this).find(".kill_tally").html(the_tally);
            });


            $("#round_index").text(state.round_index);
            $("#bot_id").text(state.bot_id);

            for (idx = 0; idx < data.bots.length; idx++) {
              agents[idx].setNext(data.bots[idx].x, data.bots[idx].y);
            }

            
            for (idx = 0; idx < state.food_eaten.length; idx++) {
              var pos = state.food_eaten[idx].food_pos;
              addAnimation(pos[0], pos[1], 3000);
            }
          };

        var ws_status = $("#ws_status");
        ws.onerror = function(event) {
          ws_status.addClass("label-warning");
          ws_status.removeClass("label-success");
          ws_status.text("Websocket error");
        };

        ws.onopen = function(event) {
          ws_status.addClass("label-success");
          ws_status.removeClass("label-warning");
          ws_status.text("Connected to " + ws_uri);
        };

        ws.onclose = function(event) {
          ws_status.removeClass("label-success");
          ws_status.removeClass("label-warning");
          ws_status.text("Connection closed");
        };

        function up(num) {
        if (agents[num]) agents[num].up();
        }
        function down(num) {
        if (agents[num]) agents[num].down();
        }
        function left(num) {
        if (agents[num]) agents[num].left();
        }
        function right(num) {
        if (agents[num]) agents[num].right();
        }
      </script>

      <form name="Formular" action="#">
        <input type="button" value=" ∧ " onclick="up(2)" />
        <input type="button" value=" ∨ " onclick="down(2)" />
        <input type="button" value=" &lt; " onclick="left(2)" />
        <input type="button" value=" &gt; " onclick="right(2)" />
      </form>


    </div>
  </body>
</html>

